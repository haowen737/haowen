# TCP连接的建立与释放（三次握手、四次挥手）
*Haowen in 2017-03-30*

TCP是面向连接的运输层协议，它提供可靠交付的、全双工的、字节流服务, 在简化的计算机网络OSI模型中，它完成第四层传输层所指定的功能。

TCP的运输连接具有三个阶段：连接建立、数据传送以及连接释放。

## TCP报文格式

![](http://function.withyoufriends.com/image/doc/170330-3.png)

几个字段
1）序号：seq序号，占32位，用来标识从tcp源端向目的端发送的字节流，发起方发送数据时对此进行标记。
2）确认序号：ack序号，占32位，只有Ack序号标志位为1时，确认序号字段才有效，Ack＝Seq＋1
3）标志位：共6个，即

	1. URG：紧急指针（urgent pointer）有效。
	2. ACK：确认序号有效。
	3. PSH：接收方应该尽快将这个报文交给应用层。
	4. RST：重置连接。
	5. SYN：发起一个新连接，
	6. FIN：释放一个连接。

#### 注意点：

1. 不要将确认序号Ack与标志位中的ACK搞混了。
2. 确认方Ack=发起方Req+1，两端配对。

### TCP的3次握手

拿到域名对应的ip地址后，User—Agent（一般指浏览器）会以一个随机端口（1024 < 端口 < 65535）向服务器的web程序（nginx， httpd...）80端口发起tcp的连接请求。

原始的http请求经过TCP/IP4层模型的层层封包，这个请求到达服务器端后，进入网卡，然后进入到内核的TCP/IP协议栈(用于识别该连接请求，解封包，一层一层剥开)，还有可能要经过防火墙的过滤，最终到达web程序，最终建立TCP/IP链接。

1）Client首先发送一个链接试探，ACK＝0表示确认号无效，SYN＝1表示这是一个连接请求或连接接受报文，同时表示这个数据报不能携带数据，seq=x表示Client自己的初始序列号（seq＝0就表示市第0号包），这时候Cilent进入syn_sent状态，等待服务器回复。
2) Server端接收连接后回复ACK报文，并为这次连接分配资源。
3）Client端接收到ACK报文后也向Server端发送ACK报文，并分配资源，这样，TCP连接旧建立了。

![](http://function.withyoufriends.com/image/doc/170330-1.png)

> 那么 为什么要三次握手？

第一次握手，客户端发包给服务器，此时服务器确认自己可以接收客户端的包，单客户端还不知道服务器是否能够接收自己发的包

第二次握手，服务器回复客户端，此时客户端确认了自己发的包被服务端收到，也确认自己可以正常接收服务器的包，客户端意见就绪通讯，但是服务器还不知道客户端能否接收到包。

第三次握手，客户端回复服务器端，服务器知道客户端已经就绪，同时也确认了自己能正常接收客户端的包，两边都没有问题，开始通信。

> 断开连接的时候发生了什么呢

发生了四次挥手

四次挥手就是指在断开一个tcp链接时，需要客户端和服务端总共发送4个包以确认连接的断开，这一过程由客户端或服务端任一方执行close来触发。

当一方完成数据发送任务后，旧发送一个FIN来终止这一方向时连接，收到一个FIN只是意味着这一方向上没有数据流动了，也就是不会再受到数据了，但是这个tcp连接上仍然能够发送数据，直到这一方也发送了FIN。首先进行关闭的一方将执行主动关闭，而另一方则执行被东莞关闭。

第一次挥手， Client发送一个FIN，用来关闭Client到Server的数据传送，Client进入FIN_WAIT_1状态。

第二次挥手，Server收到FIN后，发送一个ACK给Client，确认序号为收到序号＋1，Server进入CLOSE_WAIT状态

第三次挥手，Server发送一个FIN，用来关闭Server到Client的数据传送，Server进入LAST_ACK状态。

第四次挥手，Client收到FIN后进入TIME_WAIT状态，接着发送一个ACK给Server，确认序号为收到序号＋1，Server进入CLOSED状态，完成第四次挥手。

> 为什么建立连接是三次握手，而关闭连接却是四次挥手呢？

因为服务端在LISTEN状态下，收到建立连接请求的SYN报文后，把ACK和SYN放在一个报文里发给服务端。而关闭连接时，当对方发送FIN报文时，仅仅表示对方不再发送数据了，但此时接收数据的能力还在，己方也未必已经发所有数据都发送给对方了，所以己方可以立即close活着发送一些数据后在发送FIN表示同意关闭连接，己方的ACK和FIN一般会分开发送。

![](http://function.withyoufriends.com/image/doc/170330-2.gif)
